{% extends "base.html" %} {% load tags %} {% block content %}
<div class="container px-4 py-5" x-data="logCreationApp">
  <!-- Breadcrumbs -->
  {% include "components/breadcrumbs.html" with auto=True current_title="Create Training Log" %}

  <!-- Header Section -->
  <div class="mb-8">
    <div class="flex flex-wrap justify-between items-start gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Create Training Log</h1>
        <p class="text-gray-600 mt-1">
          For {{ trainee.first_name }} {{ trainee.last_name }} - {{course.name}}
        </p>
      </div>
      <div class="flex flex-col items-end">
        <div class="flex space-x-2">
          <div
            id="autosave-status"
            class="text-sm"
            :class="autosaveStatus.color"
          >
            <span x-text="autosaveStatus.message"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form method="post" action="" id="log-form" @submit="submitForm">
    {% csrf_token %}
    <div class="space-y-8">
      <!-- Session Details Card -->
      <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
        <h2 class="text-xl font-semibold mb-6 text-gray-800">
          Session Details
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Date -->
          <div>
            <label
              for="id_session_date"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Session Date</label
            >
            <input
              type="date"
              name="session_date"
              id="id_session_date"
              class="input input-bordered w-full"
              x-model="formData.session_date"
              @change="saveFormState"
            />
          </div>

          <!-- Position -->
          <div>
            <label
              for="id_position"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Position</label
            >
            <input
              type="text"
              name="position"
              id="id_position"
              class="input input-bordered w-full"
              placeholder="e.g. EDDF_APP"
              x-model="formData.position"
              @input="saveFormState"
            />
          </div>

          <!-- Type -->
          <div>
            <label
              for="id_type"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Session Type</label
            >
            <select
              name="type"
              id="id_type"
              class="select select-bordered w-full"
              x-model="formData.type"
              @change="saveFormState"
            >
              <option value="S">Sim</option>
              <option value="O">Online</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Evaluation Categories -->
      <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
        <h2 class="text-xl font-semibold mb-6 text-gray-800">
          Evaluation Categories
        </h2>

        <div class="space-y-8">
          <!-- Loop through all evaluation categories -->
          {% for category in categories %}
          <div>
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-medium text-gray-800">
                {{ category.label }}
              </h3>
              <select
                name="{{ category.name }}"
                id="id_{{ category.name }}"
                class="select select-sm select-bordered"
                x-model="formData.{{ category.name }}"
                @change="saveFormState"
              >
                <option value="0">Not rated</option>
                <option value="1">Requirements not met</option>
                <option value="2">Requirements partially met</option>
                <option value="3">Requirements met</option>
                <option value="4">Requirements exceeded</option>
              </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="{{ category.name }}_positives"
                  class="block text-sm font-medium text-green-600 mb-1"
                  >Strengths</label
                >
                <div class="w-full">
                  <textarea
                    id="id_{{ category.name }}_positives"
                    name="{{ category.name }}_positives"
                    x-ref="{{ category.name }}_positives"
                    x-init="setupEasyMDE($refs.{{ category.name }}_positives, '{{ category.name }}_positives')"
                  ></textarea>
                </div>
              </div>

              <div>
                <label
                  for="{{ category.name }}_negatives"
                  class="block text-sm font-medium text-red-600 mb-1"
                  >Areas for Improvement</label
                >
                <div class="w-full">
                  <textarea
                    id="id_{{ category.name }}_negatives"
                    name="{{ category.name }}_negatives"
                    x-ref="{{ category.name }}_negatives"
                    x-init="setupEasyMDE($refs.{{ category.name }}_negatives, '{{ category.name }}_negatives')"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Final Assessment -->
      <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
        <h2 class="text-xl font-semibold mb-6 text-gray-800">
          Final Assessment
        </h2>

        <div class="space-y-6">
          <div>
            <label
              for="final_comment"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Final Comment</label
            >
            <div class="w-full">
              <textarea
                id="id_final_comment"
                name="final_comment"
                x-ref="final_comment"
                x-init="setupEasyMDE($refs.final_comment, 'final_comment')"
              ></textarea>
            </div>
          </div>

          <!-- Internal Remarks -->
          <div>
            <label
              for="internal_remarks"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Internal Remarks <span class="text-xs text-gray-500">(only visible to trainers)</span></label
            >
            <div class="w-full">
              <textarea
                id="id_internal_remarks"
                name="internal_remarks"
                x-ref="internal_remarks"
                x-init="setupEasyMDE($refs.internal_remarks, 'internal_remarks')"
              ></textarea>
            </div>
          </div>

          <!-- Next step normal text input -->
          <div>
            <label
              for="next_step"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Next Step</label
            >
            <input
              type="text"
              id="next_step"
              name="next_step"
              x-model="formData.next_step"
              maxlength="35"
              class="input input-bordered w-full"
              placeholder="Enter the next step here..."
              @input="saveFormState"
            />
          </div>

          <!-- Training passed radio -->
          <div>
            <label for="id_result" class="block text-sm font-medium text-gray-700 mb-1">Training Result</label>
            <div class="flex items-center space-x-4 h-full pt-2">
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="result" value="true" class="radio radio-success"
                       x-model="formData.result"
                       @change="saveFormState">
                <span class="ml-2">Passed</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="result" value="false" class="radio radio-error"
                       x-model="formData.result"
                       @change="saveFormState">
                <span class="ml-2">Not Passed</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex justify-between">
        <a
          href="{% url 'overview:overview' %}"
          class="btn"
          @click="handleNavigation"
          >Cancel</a
        >
        <div class="space-x-2">
          <button
            id="save-draft-btn"
            type="button"
            @click="saveDraft"
            class="btn btn-outline"
          >
            Save Draft
          </button>
          <button type="submit" class="btn btn-primary">Submit Log</button>
        </div>
      </div>
    </div>
  </form>

  <!-- Confirmation Modal for Leaving Page -->
  <div
    x-show="showUnsavedChangesModal"
    class="fixed inset-0 flex items-center justify-center"
    x-cloak
  >
    <div
      style="background-color: rgba(0, 0, 0, 0.4)"
      class="size-full fixed"
    ></div>
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 z-50 relative"
    >
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Unsaved Changes</h3>
      <p class="text-gray-700 mb-6">
        You have unsaved changes. Are you sure you want to leave this page?
      </p>
      <div class="flex justify-end space-x-3">
        <button
          @click="showUnsavedChangesModal = false"
          class="btn btn-outline"
        >
          Stay on Page
        </button>
        <button @click="proceedWithNavigation" class="btn btn-error">
          Leave Page
        </button>
      </div>
    </div>
  </div>

  <!-- Saved Draft Modal -->
  <div
    x-show="showSavedDraftModal"
    class="fixed inset-0 flex items-center justify-center z-50"
    x-cloak
  >
    <div
      style="background-color: rgba(0, 0, 0, 0.4)"
      class="size-full fixed"
    ></div>
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 z-50 relative"
    >
      <div class="flex items-center justify-center mb-4 text-green-500">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-12 w-12"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2 text-center">
        Draft Saved Successfully
      </h3>
      <p class="text-gray-700 mb-6 text-center">
        Your training log draft has been saved to your browser's storage.
      </p>
      <div class="flex justify-center">
        <button @click="showSavedDraftModal = false" class="btn btn-primary">
          Continue Editing
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Font Awesome for the icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Add EasyMDE CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<!-- Add EasyMDE JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>

<script>
  document.addEventListener("alpine:init", () => {
    // Main Form Application
    Alpine.data("logCreationApp", () => ({
      formData: {
        session_date: new Date().toISOString().split("T")[0],
        position: '{{ form.position.value|default:"" }}',
        type: '{{ form.type.value|default:"O" }}',

        // All rating categories
        theory: '{{ form.theory.value|default:"0" }}',
        phraseology: '{{ form.phraseology.value|default:"0" }}',
        coordination: '{{ form.coordination.value|default:"0" }}',
        tag_management: '{{ form.tag_management.value|default:"0" }}',
        situational_awareness:
          '{{ form.situational_awareness.value|default:"0" }}',
        problem_recognition: '{{ form.problem_recognition.value|default:"0" }}',
        traffic_planning: '{{ form.traffic_planning.value|default:"0" }}',
        reaction: '{{ form.reaction.value|default:"0" }}',
        separation: '{{ form.separation.value|default:"0" }}',
        efficiency: '{{ form.efficiency.value|default:"0" }}',
        ability_to_work_under_pressure:
          '{{ form.ability_to_work_under_pressure.value|default:"0" }}',
        motivation: '{{ form.motivation.value|default:"0" }}',

        next_step: '{{ form.next_step.value|default:"" }}',
        result: '{{ form.result.value|default:"" }}',
        internal_remarks: '{{ form.internal_remarks.value|default:"" }}',
        final_comment: '{{ form.final_comment.value|default:"" }}',
      },
      // Store all EasyMDE instances
      easyMDEInstances: {},
      initialFormState: "",
      hasChanges: false,
      autosaveStatus: {
        message: "Ready",
        color: "text-gray-500",
      },
      autosaveTimer: null,
      showUnsavedChangesModal: false,
      showSavedDraftModal: false,
      navigateTo: null,
      draftKey: "",

      init() {
        // Generate unique key for storing this log draft
        this.draftKey = `log_draft_{{ trainee.id }}_{{ course.id }}`;

        // Load saved draft if exists
        this.$nextTick(() => {
          this.loadDraft();
        });

        // Set initial form state to detect changes
        setTimeout(() => {
          this.setInitialFormState();
        }, 300);
      },

      setupEasyMDE(element, fieldName) {
        if (!element) return;
        
        // Configure EasyMDE options for this field
        const instance = new EasyMDE({
          element: element,
          status: false,
          spellChecker: false,
          autoDownloadFontAwesome: true, // Force download Font Awesome to ensure icons are visible
          placeholder: `Write your ${fieldName.includes('positives') ? 'strengths' : fieldName.includes('negatives') ? 'improvement areas' : 'content'} here...`,
          autosave: {
            enabled: true,
            uniqueId: `${this.draftKey}_${fieldName}`,
            delay: 1000,
          },
          toolbar: [
            "bold", "italic", "heading", "|",
            "unordered-list", "ordered-list", "|",
            "link", "image", "|",
            "preview"
          ],
          minHeight: "100px",
          hideIcons: ["side-by-side", "fullscreen"],
          previewImagesInEditor: true,
          lineWrapping: true,
        });
        
        this.easyMDEInstances[fieldName] = instance;
        
        // Load any saved content from localStorage
        const savedContent = localStorage.getItem(`${this.draftKey}_${fieldName}_content`);
        if (savedContent) {
          instance.value(savedContent);
        }
        
        // Listen for changes and save them
        instance.codemirror.on("change", () => {
          localStorage.setItem(`${this.draftKey}_${fieldName}_content`, instance.value());
          this.saveFormState();
        });
        
        return instance;
      },

      setupBeforeUnload() {
        window.addEventListener("beforeunload", (e) => {
          if (this.hasChanges) {
            e.preventDefault();
            e.returnValue = "You have unsaved changes. Are you sure you want to leave?";
            return e.returnValue;
          }
        });
      },

      setInitialFormState() {
        this.initialFormState = JSON.stringify(this.formData);
        this.hasChanges = false;
      },

      updateSaveStatus(message, type = "info") {
        const colors = {
          info: "text-blue-500",
          success: "text-green-500",
          error: "text-red-500",
          default: "text-gray-500",
        };

        this.autosaveStatus = {
          message: message,
          color: colors[type] || colors["default"],
        };

        if (type === "success") {
          setTimeout(() => {
            this.autosaveStatus = {
              message: "",
              color: "",
            };
          }, 3000);
        }
      },

      saveFormState() {
        clearTimeout(this.autosaveTimer);

        this.updateSaveStatus("Saving...", "info");

        this.hasChanges = true;

        try {
          // Save basic form fields
          localStorage.setItem(
            `${this.draftKey}_formData`,
            JSON.stringify(this.formData)
          );

          this.updateSaveStatus("Draft saved", "success");
        } catch (e) {
          console.error("Error saving form state:", e);
          this.updateSaveStatus("Error saving draft", "error");
        }
      },

      loadDraft() {
        try {
          // Load basic form data
          const savedFormData = localStorage.getItem(`${this.draftKey}_formData`);
          if (savedFormData) {
            const parsedData = JSON.parse(savedFormData);
            this.formData = { ...this.formData, ...parsedData };
          }

          this.updateSaveStatus("Draft loaded", "success");
        } catch (e) {
          console.error("Error loading draft:", e);
          this.updateSaveStatus("Error loading draft", "error");
        }
      },

      saveDraft() {
        // Explicitly save all content
        this.saveFormState();
        this.showSavedDraftModal = true;
      },

      submitForm(e) {
        // Copy all EasyMDE content to hidden inputs before submission
        Object.keys(this.easyMDEInstances).forEach(fieldName => {
          const instance = this.easyMDEInstances[fieldName];
          const input = document.getElementById(`id_${fieldName}`);
          if (instance && input) {
            input.value = instance.value();
          }
        });
        
        // Form will submit normally
        return true;
      },

      handleNavigation(e) {
        if (this.hasChanges) {
          e.preventDefault();
          this.navigateTo = e.target.href;
          this.showUnsavedChangesModal = true;
        }
      },

      proceedWithNavigation() {
        window.removeEventListener("beforeunload", () => {});
        window.location.href = this.navigateTo;
      }
    }));
  });
</script>

<style>
  /* Custom styles for EasyMDE */
  .EasyMDEContainer {
    box-shadow: none !important;
  }
  
  .EasyMDEContainer .CodeMirror {
    border: 1px solid #e2e8f0 !important;
    border-bottom-left-radius: 0.5rem !important;
    border-bottom-right-radius: 0.5rem !important;
  }
  
  .editor-toolbar {
    border: 1px solid #e2e8f0 !important;
    background-color: #f8fafc !important;
    border-top-left-radius: 0.5rem !important;
    border-top-right-radius: 0.5rem !important;
    padding: 6px !important;
  }
  
  .editor-toolbar button {
    color: #4b5563 !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 30px !important;
    height: 30px !important;
  }
  
  .editor-toolbar button i.fa {
    font-size: 16px !important;
    display: inline-block !important;
    color: #4b5563 !important;
  }
  
  .editor-toolbar button:hover, 
  .editor-toolbar button.active {
    background-color: #e2e8f0 !important;
    border-color: #cbd5e1 !important;
  }
  
  /* Fix separator visibility */
  .editor-toolbar i.separator {
    border-left: 1px solid #cbd5e1 !important;
    border-right: 1px solid #fff !important;
    margin: 0 4px !important;
  }
  
  /* Make sure proper spacing and alignment for buttons with text */
  .editor-toolbar button.heading-1:after,
  .editor-toolbar button.heading-2:after,
  .editor-toolbar button.heading-3:after {
    position: relative !important;
    top: 1px !important;
  }
  
  /* Style the preview pane to match our design */
  .editor-preview {
    background-color: #f9fafb !important;
    border: 1px solid #e2e8f0 !important;
    border-bottom-left-radius: 0.5rem !important;
    border-bottom-right-radius: 0.5rem !important;
    padding: 1rem !important;
  }
  
  .editor-preview h1,
  .editor-preview h2,
  .editor-preview h3,
  .editor-preview h4,
  .editor-preview h5,
  .editor-preview h6 {
    font-weight: 600 !important;
    margin-top: 1rem !important;
    margin-bottom: 0.5rem !important;
  }
  
  .editor-preview h1 {
    font-size: 1.2rem !important;
  }
  
  .editor-preview h2 {
    font-size: 1.1rem !important;
  }
  
  .editor-preview h3 {
    font-size: 1rem !important;
  }
  
  .editor-preview ul,
  .editor-preview ol {
    padding-left: 1.5rem !important;
    margin-bottom: 1rem !important;
  }
  
  .editor-preview ul {
    list-style-type: disc !important;
  }
  
  .editor-preview ol {
    list-style-type: decimal !important;
  }
  
  .editor-preview p {
    margin-bottom: 1rem !important;
  }
  
  .editor-preview a {
    color: #3b82f6 !important;
    text-decoration: underline !important;
  }
  
  .editor-preview img {
    max-width: 100% !important;
    border-radius: 0.375rem !important;
    margin: 1rem 0 !important;
  }
  
  .editor-preview blockquote {
    border-left: 4px solid #e5e7eb !important;
    padding-left: 1rem !important;
    margin-left: 0 !important;
    color: #6b7280 !important;
  }
  
  .editor-preview code {
    background-color: #f3f4f6 !important;
    padding: 0.125rem 0.25rem !important;
    border-radius: 0.25rem !important;
    font-family: monospace !important;
  }
  
  .editor-preview pre {
    background-color: #f3f4f6 !important;
    padding: 1rem !important;
    border-radius: 0.375rem !important;
    overflow-x: auto !important;
    margin-bottom: 1rem !important;
  }
  
  .editor-preview pre code {
    background-color: transparent !important;
    padding: 0 !important;
  }
</style>

{% endblock %}